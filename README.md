# API GATEWAY

This API Gateway package is to be used by FYP Management System. 
The Gateway is built using [Express Gateway Library](https://www.express-gateway.io/).
### Prerequisites

1. Install [NodeJs](https://nodejs.org/en/download/)
2. Run ```npm install``` to install all required dependencies
3. Ensure you have ```.env``` at root directory. This file used to store paths to BE servers, environment (PROD, STAGING or DEV) and at which port the Gateway is running.
4. Install Redis DB using the following commands: (Linux):

    **IMPORTANT NOTE: please check your server provider as they might have external libraries that do all the Installation and Configuration steps in single line. For example: ec2 has epel, which only requires to just run ```sudo yum install redis``` and you are ready to go!**

     A. **Installation**: _reference_ [medium article](https://medium.com/@ss.shawnshi/how-to-install-redis-on-ec2-server-for-fast-in-memory-database-f30c3ef8c35e)

    1. ```cd /usr/local/src```, to install redis in this location.

    - Install and unpack Redis stable release

    1. ```sudo wget http://download.redis.io/releases/redis-stable.tar.gz```
    2. ```sudo tar xzf redis-stable.tar.gz```
    3. ```cd redis-stable```
    4. ```make```, make sure you have gcc complier installed

    - Copy running commands to bin folder

    1. ```sudo cp src/redis-server /usr/local/bin/```
    2. ```sudo cp src/redis-cli /usr/local/bin/```

    - Test by using ```redis-server```

    B. **Run it using systemctl command**: _reference_ [digital ocean](https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-redis-on-ubuntu-16-04)

    - Create a configuration diroctory and copy ```redis.conf``` file to it:

    1. ```sudo mkdir /etc/redis```
    2. ```sudo cp /usr/local/src/redis-stable/redis.conf /etc/redis```

    - Edit ```redis.conf``` file to specify where you want to dump the persistent data. This can be found at ```dir``` option in the config file

    - Create systemd unit file to run Redis

    1. ```sudo nano /etc/systemd/system/redis.service```
        - add the following content:
            ```
            [Unit]
            Description=Redis In-Memory Data Store
            After=network.target

            [Service]
            Type=forking
            User=user # please change this accordingly
            Group=group # please change this accordingly
            ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf
            ExecStop=/usr/local/bin/redis-cli shutdown
            Restart=always

            [Install]
            WantedBy=multi-user.target
            ```
    C. **Start and Test**

    - To start Redis server: ```sudo systemctl start redis```
    - To test server is running: ```sudo systemctl status redis```
    - Ensure that Redis is running at port 6379
    - If Redis is to be running in a different server, [System.config.yml](config/system.config.yml) can be modified to point to the target server. 

## Getting Started

* To run the API Gateway:
```
npm start
```

### Project Structure

* [server](server.js)
    * This is the driver script that is resposible to run the server.
* [store token](plugins/store_token.js)
    * This policy is used to generate an opaque token based and store it in a database. The key is the opaque token and value is JWT
    * Opaque token is generated based on timestamp and random values
    * Set cookies values for ```token```, ```userID```and ```roles```.
    * As we are using the [users](config/models/users.json) as the schema, username field is for storing opaque token and jwt_token  is for storing JWT.
* [validate session](plugins/validate_session.js)
    * This policy is applied for all requests except for log-in request. This policy is used for both verifications, at page level and at API request level.
* [logout](plugins/logout.js)
    * Retrieve the opaque token from the cookie and delete it from the DB, as well delete it from the cookie along with ```userID``` and ```role```
* [users](config/models/users.json)
    * This model is used as a schema to store toknes in Reids DB
    * ```username``` field is storing the opaque token generated by the Gateway
    * ```token_jwt``` field is storing the jwt generated by auth server
    * application & credentials models are default schema for Express Gateway Library (not being used in our gateway server) 
* [gateway.config.yml](config/gateway.config.yml)
    * This file does the magic to connect FE with BE.
    * File Structure:
        * ```apiEndpoints:``` list all paths to be called by FE. Each list of paths has an identifier which helps in matching a given path/s with a specific server. 
        * ```serviceEndpoints``` list all BE servers and their host address
        * ```policies``` list all policies that can be used by the Gateway before forwarding the request back to FE. A ```policy``` is a middleware which allow to do operation on the request before forwarding it. 
        * ```pipelines``` each pipeline has its own list of policies. Identifiers of ```apiEndpoints``` to specify the list of policies to applied to all requests for that apiEndpoint. ```proxy``` pipeline is used to forward to ```serviceEndpoints```. 
* [system.config.yml](config/system.config.yml)
    * Define system level configurations
    * File Structure:
        * __db__: define the db connection detials.
        * _Note_: Express Gateway only supports Redis DB which is a document based DB.
        * __plugins__: import local developed plugins. _in our case we are only having policies_

## Authors

* **Ahmed Alasaifer** 
* **Ibrahim Sharaawy**
